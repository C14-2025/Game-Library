pipeline {
    agent any // Para o Quality Gate funcionar, baixa os plugins Jacoco e Warnings no Jenkins

    tools {
        jdk 'JDK21'      // Verifique se o nome no seu Jenkins é EXATAMENTE esse
        maven 'maven-3.9' // Verifique se o nome no seu Jenkins é EXATAMENTE esse
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/C14-2025/Game-Library.git'
            }
        }

        stage('Build & Tests') {
            steps {
                dir('Game-Library') {
                    bat "mvn clean test checkstyle:check pmd:cpd pmd:pmd spotbugs:check"
                }
            }
        }

    }

    post {
        always {
            dir('Game-Library') {
                junit 'target/surefire-reports/*.xml'

                jacoco(
                    execPattern: 'target/jacoco.exec',
                    classPattern: 'target/classes',
                    sourcePattern: 'src/main/java',
                    exclusionPattern: 'src/test*'
                )

                recordIssues(
                    tools: [
                        checkstyle(pattern: 'target/checkstyle-result.xml'),
                        pmdParser(pattern: 'target/pmd.xml'),
                        cpd(pattern: 'target/cpd.xml'),
                        spotBugs(pattern: 'target/spotbugsXml.xml')
                    ],
                    qualityGates: [[threshold: 1, type: 'TOTAL', unstable: true]]
                )
            }
        }
    }
}