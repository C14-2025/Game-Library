pipeline {
    agent any

    //Plugins necessários:
    // Email Extension
    // JUnit Plugin

    // Para enviar e-mails,
    // é necessário configurar o servidor SMTP em
    // "Gerenciar Jenkins" > "Configurar o Sistema" > "Extended E-mail Notification"

    tools {
        jdk 'JDK21' //No Jenkins, o nome deve corresponder ao configurado em "Gerenciar Jenkins" > "Configurar o Sistema"
        maven 'maven-3.9' //No Jenkins, o nome deve corresponder ao configurado em "Gerenciar Jenkins" > "Configurar o Sistema"
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'Clonando repositório...'
                git branch: 'main',
                    url: 'https://github.com/C14-2025/Game-Library.git'
            }
        }

        stage('Build') {
            steps {
                echo "Compilando o projeto..."
                bat "mvn clean package -DskipTests"
            }
        }

        stage('Tests') {
            steps {
                echo 'Executando testes...'
                bat "mvn test"
            }
            post {
                always {
                    echo "Postando os relatórios xml dos testes"
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }

    stage('Site Report') {
        steps {
            echo "Gerando relatório HTML do projeto..."
            bat "mvn site"
            }
            post {
                always {
                    echo "Arquivando relatório HTML para download..."
                    archiveArtifacts artifacts: 'target/site/**/*', fingerprint: true
                }
            }
        }


        stage('Deploy') {
            steps {
                dir('Game-Library') {
                    echo "Executando deploy local..."
                    // Simulação de deploy,
                    // copiando o artefato para um diretório local C:\deploy
                    bat """
                        bat "mkdir deploy || echo 'pasta já existente'"
                        bat "copy target\\Game-Library-1.0-SNAPSHOT.jar deploy\\Game-Library.jar"
                    """
                    // mkdir cria o diretório se ele não existir,
                    // copy copia o arquivo jar para o diretório de deploy
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline finalizada com sucesso!"

            emailext(
                subject: "Jenkins - Build Realizada com SUCESSO",
                to: "lucas.caetano.comercial@gmail.com",
                body: """\
                    <p>A pipeline do projeto <b>Game-Library</b> foi concluída com <span style='color:green;'><b>sucesso</b></span>.</p>
                    <p>O relatório HTML está disponível no Jenkins, na aba <b>Artifacts</b></p>
                """
            )
        }

        failure {
            echo "Pipeline falhou!"

            emailext(
                subject: "Jenkins - Build FRACASSADA",
                to: "lucas.caetano.comercial@gmail.com",
                body: """\
                    <p>A pipeline do projeto <b>Game-Library</b> <span style='color:red;'><b>falhou</b></span>.</p>
                    <p>Verifique os logs no Jenkins para detalhes.</p>
                """
            )
        }
    }
}
